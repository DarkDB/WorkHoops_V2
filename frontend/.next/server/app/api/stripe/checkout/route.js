"use strict";(()=>{var e={};e.id=457,e.ids=[457,331],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},50852:e=>{e.exports=require("async_hooks")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},84492:e=>{e.exports=require("node:stream")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},50479:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>b,requestAsyncStorage:()=>w,routeModule:()=>h,serverHooks:()=>x,staticGenerationAsyncStorage:()=>_});var n={};t.r(n),t.d(n,{POST:()=>y});var a=t(49303),i=t(88716),s=t(60670),o=t(87070),u=t(75571),p=t(90455),l=t(72331),c=t(69206),d=t(35860),f=t(91585);let m=f.Ry({opportunityId:f.Z_().cuid(),planId:f.Km(["free","featured"])});async function y(e){try{let r=e.ip||e.headers.get("x-forwarded-for")||"unknown";if(!(await (0,d.Ir)(r,5,6e4)).success)return o.NextResponse.json({error:"Too many requests"},{status:429});let t=await (0,u.getServerSession)(p.L);if(!t?.user?.id)return o.NextResponse.json({error:"Authentication required"},{status:401});if(!["org","admin"].includes(t.user.role))return o.NextResponse.json({error:"Insufficient permissions"},{status:403});let n=await e.json(),a=m.safeParse(n);if(!a.success)return o.NextResponse.json({error:"Invalid input",details:a.error.errors},{status:400});let{opportunityId:i,planId:s}=a.data,f=await l.prisma.opportunity.findUnique({where:{id:i},include:{organization:{select:{ownerId:!0,name:!0}}}});if(!f)return o.NextResponse.json({error:"Opportunity not found"},{status:404});if("org"===t.user.role&&f.organization.ownerId!==t.user.id)return o.NextResponse.json({error:"You can only publish opportunities for your own organization"},{status:403});if("borrador"!==f.status)return o.NextResponse.json({error:"Opportunity is not in draft state"},{status:400});if("free"===s){let e=await l.prisma.opportunity.update({where:{id:i},data:{status:"publicada",publishedAt:new Date}});return await l.prisma.auditLog.create({data:{actorId:t.user.id,action:"published_free",entity:"opportunity",entityId:i,metadata:JSON.stringify({planId:s,title:f.title})}}),o.NextResponse.json({success:!0,opportunity:e,message:"Opportunity published successfully"})}let y=c.lV[s];if(!y||!y.priceId)return o.NextResponse.json({error:"Invalid plan"},{status:400});let h=`${process.env.APP_URL}/dashboard/opportunities?payment=success`,w=`${process.env.APP_URL}/publicar/${i}?payment=cancelled`,_=await (0,c.Mc)(s,i,t.user.email,h,w);return o.NextResponse.json({checkoutUrl:_.url,sessionId:_.id})}catch(e){return console.error("Stripe checkout error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stripe/checkout/route",pathname:"/api/stripe/checkout",filename:"route",bundlePath:"app/api/stripe/checkout/route"},resolvedPagePath:"/app/frontend/app/api/stripe/checkout/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:_,serverHooks:x}=h,g="/api/stripe/checkout/route";function b(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:_})}},90455:(e,r,t)=>{t.d(r,{L:()=>s});var n=t(7585),a=t(72331),i=t(53797);let s={adapter:(0,n.N)(a.prisma),session:{strategy:"jwt"},pages:{signIn:"/auth/login"},providers:[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let r=await a.prisma.user.findUnique({where:{email:e.email}});if(!r)return null;return{id:r.id,email:r.email,name:r.name,role:r.role,planType:r.planType}}catch(e){return console.error("Auth error:",e),null}}})],callbacks:{session:async({session:e,token:r})=>(r&&e.user&&(e.user.id=r.id,e.user.role=r.role,e.user.planType=r.planType),e),jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.role=r.role,e.planType=r.planType),e)}}},72331:(e,r,t)=>{t.d(r,{prisma:()=>a});var n=t(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query"]})},35860:(e,r,t)=>{t.d(r,{Ir:()=>i});let n=new Map;async function a(e,r=10,t=6e4){let a=Date.now(),i=a-t,s=n.get(e)||[],o=(s=s.filter(e=>e.timestamp>i)).length;if(o>=r){let e=s[0];return{success:!1,limit:r,remaining:0,reset:new Date(e?e.timestamp+t:a+t)}}return s.push({timestamp:a,count:1}),n.set(e,s),{success:!0,limit:r,remaining:Math.max(0,r-(o+1)),reset:new Date(a+t)}}async function i(e,r=10,t=6e4){return a(`ip:${e}`,r,t)}},69206:(e,r,t)=>{t.d(r,{MP:()=>o,Mc:()=>s,_g:()=>u,lV:()=>i});var n=t(53114);if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is required");let a=new n.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"}),i={free:{name:"Plan Gratuito",priceId:null,price:0,features:["Publicaci\xf3n b\xe1sica","Visibilidad 30 d\xedas","Soporte por email"],maxPublications:1},featured:{name:"Plan Destacado",priceId:process.env.STRIPE_FEATURED_PRICE_ID||"price_featured_placeholder",price:29,features:["Publicaci\xf3n destacada","Visibilidad 60 d\xedas","Promoci\xf3n en redes sociales","Soporte prioritario"],maxPublications:5}};async function s(e,r,t,n,s){let o=i[e];if(!o||!o.priceId)throw Error("Invalid plan or plan does not require payment");return await a.checkout.sessions.create({payment_method_types:["card"],line_items:[{price:o.priceId,quantity:1}],mode:"payment",customer_email:t,client_reference_id:r,metadata:{opportunityId:r,planId:e},success_url:n,cancel_url:s,automatic_tax:{enabled:!0},billing_address_collection:"required"})}function o(e,r){let t=process.env.STRIPE_WEBHOOK_SECRET;if(!t)throw Error("STRIPE_WEBHOOK_SECRET is required");return a.webhooks.constructEvent(e,r,t)}async function u(e){let r=e.client_reference_id,n=e.metadata?.planId;if(!r||!n)throw Error("Missing opportunity ID or plan ID in session metadata");let{prisma:a}=await t.e(331).then(t.bind(t,72331)),{sendPaymentConfirmationEmail:s}=await Promise.all([t.e(495),t.e(119)]).then(t.bind(t,36119)),o={status:"publicada",publishedAt:new Date};"featured"===n&&(o.featured=!0);let u=await a.opportunity.update({where:{id:r},data:o,include:{organization:{include:{owner:!0}}}});await a.auditLog.create({data:{actorId:u.authorId,action:"payment_completed",entity:"opportunity",entityId:u.id,metadata:JSON.stringify({planId:n,sessionId:e.id,amount:e.amount_total,currency:e.currency})}}),u.organization.owner.email&&await s(u.organization.owner.email,u.organization.name,u.title,i[n].name)}},69955:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0})},75571:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0});var n={};Object.defineProperty(r,"default",{enumerable:!0,get:function(){return i.default}});var a=t(69955);Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in r&&r[e]===a[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return a[e]}}))});var i=function(e,r){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=s(void 0);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&({}).hasOwnProperty.call(e,i)){var o=a?Object.getOwnPropertyDescriptor(e,i):null;o&&(o.get||o.set)?Object.defineProperty(n,i,o):n[i]=e[i]}return n.default=e,t&&t.set(e,n),n}(t(45609));function s(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(s=function(e){return e?t:r})(e)}Object.keys(i).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in r&&r[e]===i[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return i[e]}}))})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[948,972,544,585,724],()=>t(50479));module.exports=n})();